# Puppet CI Resources

classes:
  - nsidc_jenkins
  - nsidc_nfs

# NFS Mounts
nsidc_nfs::sharemounts:
  /share/sw/packages:
    project: sw
    share: packages

# Jenkins Plugins
nsidc_jenkins::plugins:
  git: {}
  git-client: {}
  git-parameter: {}
  scm-api: {}
  credentials: {}
  ssh-credentials: {}
  greenballs: {}
  jobConfigHistory: {}
  mailer: {}
  instant-messaging: {}
  jabber: {}
  ansicolor: {}
  simple-theme-plugin: {}



base_workspace: /var/lib/jenkins/workspaces/%{hiera('project')}
ci_workspace: "%{hiera('base_workspace')}/ci"
release_workspace: "%{hiera('base_workspace')}/release"

gem_name: search_solr_tools
refresh_gem_index: sudo -u scm ruby1.9.1 /usr/bin/gem generate_index -d /share/sw/packages/ruby/nsidc

job_ci_checkout: "%{hiera('project')}_CI_1_Checkout_Project"
job_ci_install_deps: "%{hiera('project')}_CI_2_Install_Dependencies"
job_ci_syntax: "%{hiera('project')}_CI_3_RuboCop"
job_ci_unit_tests: "%{hiera('project')}_CI_4_Unit_Tests"
job_ci_publish_prerelease: "%{hiera('project')}_CI_5_Create_Prerelease"

job_release_create_release: "%{hiera('project')}_Release_1_Create_Release"
job_release_deploy_package: "%{hiera('project')}_Release_2_Deploy_Gem"

cmd_install_deps: bundle install --path /var/lib/jenkins/gems/
cmd_syntax: bundle exec rubocop --display-cop-names
cmd_unit_tests: bundle exec rake spec:unit

cmd_publish_prerelease: |
  bumpversion build
  bundle exec gem build %{hiera('gem_name')}.gemspec

  sudo -u scm cp %{hiera('gem_name')}-*.gem /share/sw/packages/ruby/nsidc/gems/
  %{hiera('refresh_gem_index')}

  git push origin --all
  git push origin --tags

cmd_create_release: |
  git checkout $ref

  %{hiera('cmd_install_deps')}

  if [ "$version_type" != "none" ]; then
    bumpversion $version_type
  fi

  bumpversion release
  bundle exec gem build %{hiera('gem_name')}.gemspec

  # create next pre-release
  bumpversion patch

  git push origin --all
  git push origin --tags

cmd_deploy_package: |
  sudo -u scm cp %{hiera('gem_name')}-*.gem /share/sw/packages/ruby/nsidc/gems/
  %{hiera('refresh_gem_index')}



# Jenkins Jobs
nsidc_jenkins::jobs:

  "%{hiera('job_ci_checkout')}":
    workspace: "%{hiera('ci_workspace')}"
    parameters:
      - type: string
        name: ref
        description: git ref (branch, tag, or SHA) to checkout
        default: master
    git:
      repo: "%{hiera('gitrepo')}"
      poll_scm: true
      checkout_local: false
    command: git checkout $ref
    trigger_job: "%{hiera('job_ci_install_deps')}"


  "%{hiera('job_ci_install_deps')}":
    workspace: "%{hiera('ci_workspace')}"
    command: "%{hiera('cmd_install_deps')}"
    trigger_job: "%{hiera('job_ci_syntax')}"


  "%{hiera('job_ci_syntax')}":
    workspace: "%{hiera('ci_workspace')}"
    command: "%{hiera('cmd_syntax')}"
    trigger_job: "%{hiera('job_ci_unit_tests')}"


  "%{hiera('job_ci_unit_tests')}":
    workspace: "%{hiera('ci_workspace')}"
    command: "%{hiera('cmd_unit_tests')}"
    trigger_job: "%{hiera('job_ci_publish_prerelease')}"


  "%{hiera('job_ci_publish_prerelease')}":
    workspace: "%{hiera('ci_workspace')}"
    command: "%{hiera('cmd_publish_prerelease')}"


  "%{hiera('job_release_create_release')}":
    description: >-
      Bump the version, tag, build the desired release gem, and push the git
      changes.
    workspace: "%{hiera('release_workspace')}"
    parameters:
      - type: string
        name: ref
        description: git ref to checkout and tag
        default: master
      - type: choice
        name: version_type
        choices:
          - none
          - minor
          - major
    git:
      repo: "%{hiera('gitrepo')}"
      poll_scm: false
      checkout_local: false
    command: "%{hiera('cmd_create_release')}"
    trigger_job: "%{hiera('job_release_deploy_package')}"


  "%{hiera('job_release_deploy_package')}":
    workspace: "%{hiera('release_workspace')}"
    command: "%{hiera('cmd_deploy_package')}"
